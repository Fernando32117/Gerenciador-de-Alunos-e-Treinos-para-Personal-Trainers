<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro de Treino</title>
  <link rel="stylesheet" href="../css/styleCadastroTreino.css">
  <script src="../js/scripts.js"></script>
  <style>
    #resultadoBusca {
      max-height: 200px;
      overflow-x: auto;
      position: sticky;
      width: 300px;
      padding: 0;
      margin: 0;
    }

    #resultadoBusca li {
      padding: 8px;
      cursor: pointer;
      list-style: none;
    }

    #resultadoBusca li:hover {
      background-color: #ffcc00;
    }
  </style>
</head>

<body>
  <div class="login">
    <h2>Cadastro de Treinos</h2>
    <form id="formCadastroTreinoAluno" onsubmit="handleCadastroTreino(event)">
      <label for="aluno">Buscar Aluno</label>
      <input type="text" id="inputBusca" placeholder="Digite o nome do aluno" onkeyup="buscarAluno()" />
      <ul id="resultadoBusca" style="list-style: none; padding: 0; margin: 0;"></ul>

      <label for="grupoMuscular">Grupo Muscular</label>
      <select id="grupoMuscular" required>
        <option value=""></option>
        <option value="peito">Peito</option>
        <option value="perna">Perna</option>
        <option value="costa">Costa</option>
        <option value="ombro">Ombro</option>
        <option value="braco-antebraco">Braço/Antebraço</option>
      </select>

      <div id="exercicioContainer">
        <!-- Este botão adicionará novos campos de exercício -->
        <button type="button" id="addExercicioBtn">Adicionar Exercício</button>
      </div>

      <button type="submit">Cadastrar Treino</button>
      <button type="button" onclick="voltarDashboardPersonal()">Voltar ao Dashboard</button>
    </form>
  </div>

  <template id="exercicioTemplate">
    <div class="exercicio">
      <label for="nomeExex">Nome do Exercício</label>
      <input type="text" class="observacoes" placeholder="Observações">

      <label for="series">Séries</label>
      <input type="number" class="series" placeholder="Séries" required>

      <label for="repeticoes">Repetições</label>
      <input type="number" class="repeticoes" placeholder="Repetições" required>

      <label for="observacoes">Observações</label>
      <input type="text" class="observacoes" placeholder="Observações">

      <h3>Escolha o Exemplo do Exercício</h3>
      <input type="file" class="gifInput" accept="image/gif" required>
      <img class="preview" src="" alt="Preview do GIF" style="display:none;">
    </div>
  </template>

  <script>
    async function buscarAluno() {
      const input = document.getElementById('inputBusca').value.trim(); // Remover espaços em branco
      const lista = document.getElementById('resultadoBusca');

      // Limpar resultados anteriores
      lista.innerHTML = '';

      // Não buscar se o campo estiver vazio
      if (input === '') {
        return; // Apenas sair da função
      }

      try {
        const response = await fetch(`http://127.0.0.1:3000/buscar-alunos?nome=${input}`);
        if (!response.ok) {
          throw new Error(`Erro na requisição: ${response.statusText}`);
        }
        const alunos = await response.json();

        // Filtrar alunos que começam exatamente com o texto digitado
        const resultadosFiltrados = alunos.filter(aluno =>
          aluno.nomeAluno.toLowerCase().startsWith(input.toLowerCase())
        );

        if (resultadosFiltrados.length === 0) {
          lista.innerHTML = '<li>Nenhum aluno encontrado</li>';
          return;
        }

        // Criar lista de sugestões
        resultadosFiltrados.forEach(aluno => {
          const item = document.createElement('li');
          item.textContent = `${aluno.nomeAluno}`;
          item.onclick = () => {
            document.getElementById('inputBusca').value = aluno.nomeAluno; // Preencher o input com o nome do aluno
            lista.innerHTML = ''; // Limpar a lista de sugestões
          };
          lista.appendChild(item);
        });
      } catch (error) {
        console.error('Erro ao buscar alunos:', error);
      }
    }

    const addExercicioBtn = document.getElementById('addExercicioBtn');
    const exercicioContainer = document.getElementById('exercicioContainer');
    const exercicioTemplate = document.getElementById('exercicioTemplate');

    addExercicioBtn.addEventListener('click', function () {
      const newExercicio = exercicioTemplate.content.cloneNode(true);
      exercicioContainer.appendChild(newExercicio);
    });

    function handleCadastroTreino(event) {
      event.preventDefault();

      const aluno = document.getElementById('aluno').value;
      const grupoMuscular = document.getElementById('grupoMuscular').value;
      const series = document.querySelectorAll('.series');
      const repeticoes = document.querySelectorAll('.repeticoes');
      const observacoes = document.querySelectorAll('.observacoes');
      const gifs = document.querySelectorAll('.gifInput');

      const formData = new FormData();
      formData.append('aluno', aluno);
      formData.append('grupoMuscular', grupoMuscular);

      series.forEach((s, index) => {
        formData.append(`series${index}`, s.value);
      });

      repeticoes.forEach((r, index) => {
        formData.append(`repeticoes${index}`, r.value);
      });

      observacoes.forEach((o, index) => {
        formData.append(`observacoes${index}`, o.value);
      });

      gifs.forEach((g, index) => {
        formData.append(`gif${index}`, g.files[0]);
      });

      fetch('http://localhost:3000/cadastroTreinoAluno', {
        method: 'POST',
        body: formData
      })
        .then(response => {
          if (!response.ok) {
            return response.json().then(error => { throw new Error(error.message); });
          }
          return response.json();
        })
        .then(data => {
          alert('Treino cadastrado com sucesso! : ' + grupoMuscular);
        })
        .catch((error) => {
          alert('Erro no cadastro: ' + error.message);
        });
    }

  </script>
</body>



</html>